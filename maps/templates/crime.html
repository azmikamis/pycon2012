<!DOCTYPE html>
<head>
  <title>Maps Tutorial @ PyCon 2012</title>
  
  <link href="http://leaflet.cloudmade.com/dist/leaflet.css" media="all" rel="stylesheet" type="text/css" />
  
  <style type="text/css">
    body { height:100% }
    #mapdiv { display:block; position:absolute; top:0; left:0; width:100%; height:100%; }
  </style> 
</head>

<body>
    <div id="mapdiv"></div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
    <script src="http://leaflet.cloudmade.com/dist/leaflet.js" type="text/javascript" type="text/javascript"></script>
    
    <script type="text/javascript">
    var styles = {
        cloudmade: "http://{s}.tile.cloudmade.com/8ee2a50541944fb9bcedded5165f09d9/997/256/{z}/{x}/{y}.png"
    };
    
    $(document).ready(function () {
        // initialize the map on the "map" div
        var map = new L.Map('mapdiv');
        
        var cloudmade = new L.TileLayer(styles.cloudmade);
        var sanfran = new L.LatLng(37.77540, -122.41941);
        map.addLayer(cloudmade).setView(sanfran, 16);
    });
    </script>
    
    <!--script type="text/javascript">
    
    function crime_refresh(event_name, event_source, event_args) {
        var bounds = event_source.getBounds();

        // geodjango's Polygon.from_bbox() expects this format for the coordinates
        var xmin = bounds.sw.lon;
        var xmax = bounds.ne.lon;
        var ymin = bounds.sw.lat;
        var ymax = bounds.ne.lat;
        var bbox = xmin + "," + ymin + "," + xmax + "," + ymax;
        
        var url = "/crime.json?bbox=" + bbox;

        $.getJSON(url, function(data) {
            var features = data.features;
            
            $.each(features, function(i, feature) {
                console.log(feature);
                event_source.addJSON(feature);
            });
        });
    }
    
    $(document).ready(function () {
        var map = new mxn.Mapstraction('mapdiv', 'leaflet');

        var sanfran = new mxn.LatLonPoint(37.77540, -122.41941);
        map.setCenterAndZoom(sanfran, 16);

        // add a marker
        var marker = new mxn.Marker(sanfran);
        map.addMarker(marker);
        marker.addData({'infoBubble': 'This is a popup'})
        marker.openBubble();

        map.addSmallControls();
        
        map.load.addHandler(crime_refresh);
        map.endPan.addHandler(crime_refresh);
        map.changeZoom.addHandler(crime_refresh);
        
        map.load.fire(); // not automatically fired
    });
    </script-->
</body>
</html>